name: Backend CD

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  JAVA_VERSION: '21'
  APP_NAME: mzc-lp-backend

jobs:
  build:
    name: Build JAR
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact-name: ${{ steps.version.outputs.artifact-name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(date +%Y%m%d)-${GITHUB_SHA::7}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact-name=${{ env.APP_NAME }}-${VERSION}.jar" >> $GITHUB_OUTPUT

      - name: Build JAR
        run: ./gradlew bootJar -x test

      - name: Rename JAR
        run: |
          mv build/libs/*.jar build/libs/${{ steps.version.outputs.artifact-name }}

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-jar
          path: build/libs/${{ steps.version.outputs.artifact-name }}
          retention-days: 30

  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment:
      name: dev
      url: https://dev-api.mzc-lp.com

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-jar

      - name: Deploy to Dev Server
        run: |
          echo "=========================================="
          echo "Deploying to Dev Environment"
          echo "Version: ${{ needs.build.outputs.version }}"
          echo "Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "=========================================="

          # TODO: 실제 배포 명령어로 교체
          # 방법 1: SCP로 파일 전송 후 SSH로 재시작
          # scp -i $SSH_KEY ${{ needs.build.outputs.artifact-name }} $DEV_SERVER:/app/
          # ssh -i $SSH_KEY $DEV_SERVER "sudo systemctl restart mzc-lp-backend"

          # 방법 2: AWS CodeDeploy 사용
          # aws deploy create-deployment --application-name mzc-lp --deployment-group dev

          ls -la

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging-api.mzc-lp.com

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-jar

      - name: Deploy to Staging Server
        run: |
          echo "=========================================="
          echo "Deploying to Staging Environment"
          echo "Version: ${{ needs.build.outputs.version }}"
          echo "=========================================="

          # TODO: 실제 배포 명령어로 교체
          ls -la

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment:
      name: production
      url: https://api.mzc-lp.com

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-jar

      - name: Deploy to Production Server
        run: |
          echo "=========================================="
          echo "Deploying to Production Environment"
          echo "Version: ${{ needs.build.outputs.version }}"
          echo "=========================================="

          # TODO: 실제 배포 명령어로 교체
          ls -la

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ needs.build.outputs.artifact-name }}
          generate_release_notes: true
